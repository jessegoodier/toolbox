name: Build and Publish Images

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch: # Manual trigger
    inputs:
      action:
        description: 'Choose action'
        required: true
        default: 'push if fixable CVE found'
        type: choice
        options:
          - 'push if fixable CVE found'
          - 'cve scan only'
          - 'push only'

env:
  REGISTRY: ghcr.io/jessegoodier

jobs:
  cve-scan:
    name: CVE Scan
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.action != 'push only') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push reports
    outputs:
      cve_found: ${{ steps.check_cve.outputs.cve_found }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Run Trivy vulnerability scanner on all images
        run: |
          mkdir -p trivy-results
          for IMAGE in toolbox toolbox-common toolbox-aws toolbox-gcp toolbox-azure; do
            echo "Scanning $REGISTRY/$IMAGE:latest..."
            trivy image --format json --output "trivy-results/$IMAGE.json" \
              --severity CRITICAL,HIGH --ignore-unfixed \
              "$REGISTRY/$IMAGE:latest" || true
          done

      - name: Check for vulnerabilities and generate report
        id: check_cve
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)
          mkdir -p cve-audit/$YEAR

          # Check if any image has vulnerabilities
          CVE_FOUND=false
          for IMAGE in toolbox toolbox-common toolbox-aws toolbox-gcp toolbox-azure; do
            if grep -q "Vulnerabilities" "trivy-results/$IMAGE.json" 2>/dev/null; then
              echo "High/Critical vulnerabilities found in $IMAGE."
              CVE_FOUND=true
            fi
          done

          if [ "$CVE_FOUND" = "true" ]; then
            echo "cve_found=true" >> $GITHUB_OUTPUT
          else
            echo "No fixable high/critical vulnerabilities found."
            echo "cve_found=false" >> $GITHUB_OUTPUT
          fi

          # Format report (updated script handles multiple images)
          python3 .github/scripts/format_cve_report.py trivy-results > cve-audit/$YEAR/$MONTH-$DAY.md

          # Commit report
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add cve-audit/$YEAR/$MONTH-$DAY.md
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: add CVE audit report for $(date +%Y-%m-%d)"
          git push

      - name: Upload CVE results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results/
          retention-days: 1

  build:
    needs: cve-scan
    if: ${{ !cancelled() && ( (github.event_name == 'workflow_dispatch' && inputs.action == 'push only') || (needs.cve-scan.result == 'success' && needs.cve-scan.outputs.cve_found == 'true' && (github.event_name == 'schedule' || inputs.action != 'cve scan only')) ) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download CVE scan results
        uses: actions/download-artifact@v4
        with:
          name: trivy-results
          path: trivy-results/
        continue-on-error: true  # May not exist for 'push only' runs

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        run: |
          ./build_images.sh
        env:
          PUSH: true
          CI: true

      - name: Generate build history report
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)
          DATE_TAG=$(date +%Y-%m-%d)
          REGISTRY="ghcr.io/jessegoodier"
          REPORT="build-history/$YEAR/$MONTH-$DAY.md"

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # Only pull if on main branch to avoid rebase conflicts on feature branches
          if [ "$(git branch --show-current)" = "main" ]; then
            git pull --rebase origin main
          fi

          mkdir -p build-history/$YEAR

          echo "# Build History - $DATE_TAG" > "$REPORT"
          echo "" >> "$REPORT"
          echo "Images built and pushed to GitHub Container Registry." >> "$REPORT"
          echo "" >> "$REPORT"
          echo "## Table of Contents" >> "$REPORT"
          echo "- [toolbox](#toolbox)" >> "$REPORT"
          echo "- [toolbox-common](#toolbox-common)" >> "$REPORT"
          echo "- [toolbox-aws](#toolbox-aws)" >> "$REPORT"
          echo "- [toolbox-gcp](#toolbox-gcp)" >> "$REPORT"
          echo "- [toolbox-azure](#toolbox-azure)" >> "$REPORT"
          echo "" >> "$REPORT"

          for IMAGE in toolbox toolbox-common toolbox-aws toolbox-gcp toolbox-azure; do
            DIGEST=$(docker buildx imagetools inspect $REGISTRY/$IMAGE:latest 2>/dev/null | grep -m1 "^Digest:" | awk '{print $2}')

            # Get architecture-specific details
            MANIFEST_INDEX=$(docker buildx imagetools inspect $REGISTRY/$IMAGE:latest --raw 2>/dev/null)
            AMD64_DIGEST=$(echo "$MANIFEST_INDEX" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest')
            ARM64_DIGEST=$(echo "$MANIFEST_INDEX" | jq -r '.manifests[] | select(.platform.architecture == "arm64" and .platform.os == "linux") | .digest')

            # Get layer info for each architecture
            AMD64_MANIFEST=$(docker buildx imagetools inspect "$REGISTRY/$IMAGE@$AMD64_DIGEST" --raw 2>/dev/null)
            ARM64_MANIFEST=$(docker buildx imagetools inspect "$REGISTRY/$IMAGE@$ARM64_DIGEST" --raw 2>/dev/null)

            AMD64_LAYERS=$(echo "$AMD64_MANIFEST" | jq '.layers | length')
            ARM64_LAYERS=$(echo "$ARM64_MANIFEST" | jq '.layers | length')
            AMD64_SIZE=$(echo "$AMD64_MANIFEST" | jq '[.layers[].size] | add')
            ARM64_SIZE=$(echo "$ARM64_MANIFEST" | jq '[.layers[].size] | add')

            # Convert to human readable MB
            AMD64_SIZE_MB=$(echo "scale=1; $AMD64_SIZE / 1048576" | bc)
            ARM64_SIZE_MB=$(echo "scale=1; $ARM64_SIZE / 1048576" | bc)

            echo "## $IMAGE" >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### Image Details" >> "$REPORT"
            echo "" >> "$REPORT"
            echo "| Architecture | Layers | Compressed Size |" >> "$REPORT"
            echo "|--------------|--------|-----------------|" >> "$REPORT"
            echo "| linux/amd64 | $AMD64_LAYERS | ${AMD64_SIZE_MB} MB |" >> "$REPORT"
            echo "| linux/arm64 | $ARM64_LAYERS | ${ARM64_SIZE_MB} MB |" >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### Latest" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "$REGISTRY/$IMAGE:latest" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### Date Tagged" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "$REGISTRY/$IMAGE:$DATE_TAG" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### SHA Pinned" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "$REGISTRY/$IMAGE@$DIGEST" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "" >> "$REPORT"

            # Add resolved CVEs section if CVE data exists for this image
            CVE_FILE="trivy-results/$IMAGE.json"
            if [ -f "$CVE_FILE" ]; then
              CVE_COUNT=$(jq '[.Results[]?.Vulnerabilities // [] | .[]?] | length' "$CVE_FILE" 2>/dev/null || echo "0")
              if [ "$CVE_COUNT" -gt 0 ]; then
                echo "### Resolved CVEs" >> "$REPORT"
                echo "" >> "$REPORT"
                echo "The following vulnerabilities were detected before this build and are now resolved:" >> "$REPORT"
                echo "" >> "$REPORT"
                echo "| ID | Severity | Package | Fixed Version |" >> "$REPORT"
                echo "|----| ---------|---------|---------------|" >> "$REPORT"

                # Extract CVE details using jq
                jq -r '
                  [.Results[]?.Vulnerabilities // [] | .[]] |
                  unique_by(.VulnerabilityID) |
                  sort_by(.Severity) |
                  reverse |
                  .[] |
                  "| [\(.VulnerabilityID)](\(.PrimaryURL // "")) | \(.Severity) | \(.PkgName) | \(.FixedVersion) |"
                ' "$CVE_FILE" >> "$REPORT" 2>/dev/null || true

                echo "" >> "$REPORT"
              fi
            fi
          done

          git add "$REPORT"
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: add build history for $DATE_TAG"
          git push
