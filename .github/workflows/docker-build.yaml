name: Build and Publish Images

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch: # Manual trigger
    inputs:
      action:
        description: 'Choose action'
        required: true
        default: 'push if fixable CVE found'
        type: choice
        options:
          - 'push if fixable CVE found'
          - 'cve scan only'
          - 'push only'

env:
  REGISTRY: ghcr.io/jessegoodier

jobs:
  cve-scan:
    name: CVE Scan
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.action != 'push only') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push reports
    outputs:
      cve_found: ${{ steps.check_cve.outputs.cve_found }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/jessegoodier/toolbox-common:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0' # Don't fail the job, we want to process results

      - name: Check for vulnerabilities and generate report
        id: check_cve
        run: |
          # Create directory
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)
          mkdir -p cve-audit/$YEAR

          # Check if results file is not empty and has vulnerabilities
          if grep -q "Vulnerabilities" trivy-results.json; then
            echo "High/Critical vulnerabilities found."
            echo "cve_found=true" >> $GITHUB_OUTPUT
          else
            echo "No fixable high/critical vulnerabilities found."
            echo "cve_found=false" >> $GITHUB_OUTPUT
          fi
            
          # Format report
          python3 .github/scripts/format_cve_report.py trivy-results.json > cve-audit/$YEAR/$MONTH-$DAY.md
          
          # Commit report
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add cve-audit/$YEAR/$MONTH-$DAY.md
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: add CVE audit report for $(date +%Y-%m-%d)"
          git push

  build:
    needs: cve-scan
    if: ${{ !cancelled() && ( (github.event_name == 'workflow_dispatch' && inputs.action == 'push only') || (needs.cve-scan.result == 'success' && needs.cve-scan.outputs.cve_found == 'true' && (github.event_name == 'schedule' || inputs.action != 'cve scan only')) ) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        run: |
          ./build_images.sh
        env:
          PUSH: true
          CI: true

      - name: Generate build history report
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)
          DATE_TAG=$(date +%Y-%m-%d)
          REGISTRY="ghcr.io/jessegoodier"
          REPORT="build-history/$YEAR/$MONTH-$DAY.md"

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git pull --rebase origin main

          mkdir -p build-history/$YEAR

          echo "# Build History - $DATE_TAG" > "$REPORT"
          echo "" >> "$REPORT"
          echo "Images built and pushed to GitHub Container Registry." >> "$REPORT"
          echo "" >> "$REPORT"
          echo "## Table of Contents" >> "$REPORT"
          echo "- [toolbox-common](#toolbox-common)" >> "$REPORT"
          echo "- [toolbox-aws](#toolbox-aws)" >> "$REPORT"
          echo "- [toolbox-gcp](#toolbox-gcp)" >> "$REPORT"
          echo "- [toolbox-azure](#toolbox-azure)" >> "$REPORT"
          echo "" >> "$REPORT"

          for IMAGE in toolbox-common toolbox-aws toolbox-gcp toolbox-azure; do
            DIGEST=$(docker buildx imagetools inspect $REGISTRY/$IMAGE:latest 2>/dev/null | grep -m1 "^Digest:" | awk '{print $2}')

            # Get architecture-specific details
            MANIFEST_INDEX=$(docker buildx imagetools inspect $REGISTRY/$IMAGE:latest --raw 2>/dev/null)
            AMD64_DIGEST=$(echo "$MANIFEST_INDEX" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest')
            ARM64_DIGEST=$(echo "$MANIFEST_INDEX" | jq -r '.manifests[] | select(.platform.architecture == "arm64" and .platform.os == "linux") | .digest')

            # Get layer info for each architecture
            AMD64_MANIFEST=$(docker buildx imagetools inspect "$REGISTRY/$IMAGE@$AMD64_DIGEST" --raw 2>/dev/null)
            ARM64_MANIFEST=$(docker buildx imagetools inspect "$REGISTRY/$IMAGE@$ARM64_DIGEST" --raw 2>/dev/null)

            AMD64_LAYERS=$(echo "$AMD64_MANIFEST" | jq '.layers | length')
            ARM64_LAYERS=$(echo "$ARM64_MANIFEST" | jq '.layers | length')
            AMD64_SIZE=$(echo "$AMD64_MANIFEST" | jq '[.layers[].size] | add')
            ARM64_SIZE=$(echo "$ARM64_MANIFEST" | jq '[.layers[].size] | add')

            # Convert to human readable MB
            AMD64_SIZE_MB=$(echo "scale=1; $AMD64_SIZE / 1048576" | bc)
            ARM64_SIZE_MB=$(echo "scale=1; $ARM64_SIZE / 1048576" | bc)

            echo "## $IMAGE" >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### Image Details" >> "$REPORT"
            echo "" >> "$REPORT"
            echo "| Architecture | Layers | Compressed Size |" >> "$REPORT"
            echo "|--------------|--------|-----------------|" >> "$REPORT"
            echo "| linux/amd64 | $AMD64_LAYERS | ${AMD64_SIZE_MB} MB |" >> "$REPORT"
            echo "| linux/arm64 | $ARM64_LAYERS | ${ARM64_SIZE_MB} MB |" >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### Latest" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "$REGISTRY/$IMAGE:latest" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### Date Tagged" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "$REGISTRY/$IMAGE:$DATE_TAG" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "" >> "$REPORT"
            echo "### SHA Pinned" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "$REGISTRY/$IMAGE@$DIGEST" >> "$REPORT"
            echo '```' >> "$REPORT"
            echo "" >> "$REPORT"
          done

          git add "$REPORT"
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: add build history for $DATE_TAG"
          git push
