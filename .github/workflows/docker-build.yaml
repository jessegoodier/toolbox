name: Build and Publish Images

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch: # Manual trigger
    inputs:
      action:
        description: 'Choose action'
        required: true
        default: 'push if fixable CVE found'
        type: choice
        options:
          - 'push if fixable CVE found'
          - 'cve scan only'
          - 'push only'

env:
  REGISTRY: ghcr.io/jessegoodier

jobs:
  cve-scan:
    name: CVE Scan
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.action != 'push only') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push reports
    outputs:
      cve_found: ${{ steps.check_cve.outputs.cve_found }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/jessegoodier/toolbox-common:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0' # Don't fail the job, we want to process results

      - name: Check for vulnerabilities and generate report
        id: check_cve
        run: |
          # Create directory
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)
          mkdir -p cve-audit/$YEAR

          # Check if results file is not empty and has vulnerabilities
          if grep -q "Vulnerabilities" trivy-results.json; then
            echo "High/Critical vulnerabilities found."
            echo "cve_found=true" >> $GITHUB_OUTPUT
            
            # Format report
            python3 .github/scripts/format_cve_report.py trivy-results.json > cve-audit/$YEAR/$MONTH-$DAY.md
            
            # Commit report
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add cve-audit/$YEAR/$MONTH-$DAY.md
            # Only commit if there are changes
            git diff --quiet && git diff --staged --quiet || git commit -m "chore: add CVE audit report for $(date +%Y-%m-%d)"
            git push
          else
            echo "No fixable high/critical vulnerabilities found."
            echo "cve_found=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: cve-scan
    if: ${{ !cancelled() && ( (github.event_name == 'workflow_dispatch' && inputs.action == 'push only') || (needs.cve-scan.result == 'success' && needs.cve-scan.outputs.cve_found == 'true' && (github.event_name == 'schedule' || inputs.action != 'cve scan only')) ) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        run: |
          ./build_images.sh
        env:
          PUSH: true
          CI: true
